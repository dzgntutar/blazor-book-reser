@page "/login"
@using System.Text.Json
@using System.Text
@using BookReservation.Client.Utils
@inject HttpClient Http

<div class="container">
	<div class="d-flex justify-content-center">
		<div class="card w-50 ">
			<div class="card-header text-center">
				<h2>Login</h2>
			</div>
			<div class="card-body">
				<EditForm Model="@user">
					<div class="form-group">
						<label>Email</label>
						<InputText class="form-control" @bind-Value="user.Email"></InputText>
					</div>
					<div class="form-group">
						<label>Password</label>
						<InputText type="password" class="form-control" @bind-Value="user.Password"></InputText>
					</div>
					<div class="form-group mt-2 d-flex  justify-content-end">
						<AddButtonComponent Color="primary" Text="Login" OnClick="Login"></AddButtonComponent>
					</div>
				</EditForm>
			</div>
		</div>
	</div>
</div>


@code {
	UserLoginDto user = new UserLoginDto() { Email = "duzgun@tutar.com", Password = "123." };

	[Inject]
	ILocalStorageService LocalStorageService { get; set; }

	[Inject]
	AuthenticationStateProvider AuthenticationStateProvider { get; set; }

	[Inject]
	HttpClient Client { get; set; }

	[Inject]
	NavigationManager NavigationManager { get; set; }

	private async void Login()
	{
		var response = await Http.PostAsJsonAsync("/api/users", user);

		if (response.IsSuccessStatusCode)
		{
			var data = await response.Content.ReadFromJsonAsync<UserLoginResponseDTO>();

			await LocalStorageService.SetItemAsync("token", data.ApiToken);
			await LocalStorageService.SetItemAsync("email", data.User.Email);
			await LocalStorageService.SetItemAsync("userId", data.User.Id);
			await LocalStorageService.SetItemAsync("userName", $"{data.User.FirstName} {data.User.LastName}");

			(AuthenticationStateProvider as AuthStateProvider).NotifyUserLogin(data.User.Email);

			Client.DefaultRequestHeaders.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", data.ApiToken);

			NavigationManager.NavigateTo("/");
		}
		else
		{
			//Error message
		}
	}

}
